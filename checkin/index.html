<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>CC Shield Check-in System 2026</title>

<style>
/* å®šç¾©å…¨åŸŸé¡è‰²è®Šæ•¸ï¼Œæ–¹ä¾¿æ—¥å¾Œçµ±ä¸€ä¿®æ”¹ä¸»é¡Œè‰² */
:root {
  --bg-color: #0e0e0e;
  --primary: #1E88E5;   /* è—è‰²ï¼šä¸€èˆ¬æ“ä½œ */
  --success: #43A047;   /* ç¶ è‰²ï¼šæˆåŠŸ/é¦–æ¬¡ */
  --warning: #F9A825;   /* é»ƒè‰²ï¼šæ‰‹å‹•è¼¸å…¥ */
  --danger: #E53935;    /* ç´…è‰²ï¼šéŒ¯èª¤ */
}

body {
  font-family: -apple-system, sans-serif;
  background: var(--bg-color);
  color: #fff;
  margin: 0;
  text-align: center;
}

header {
  background: #000;
  padding: 20px;
  font-size: 22px;
  font-weight: bold;
  border-bottom: 2px solid #333;
}

/* é é¢åˆ‡æ›é‚è¼¯ï¼šéš±è—æ‰€æœ‰ class ç‚º page çš„ divï¼Œé™¤éå®ƒæ²’æœ‰ hidden class */
.page { padding: 20px; }
.hidden { display: none; }

/* æŒ‰éˆ•æ¨£å¼ï¼šåŠ å…¥é»æ“Šç¸®æ”¾å‹•ç•«ï¼Œå¢åŠ æ‰‹æ„Ÿ */
button {
  width: 95%; max-width: 400px;
  padding: 18px; margin: 10px auto;
  font-size: 20px; border-radius: 12px; border: none;
  cursor: pointer; font-weight: bold;
  transition: transform 0.1s;
}
button:active { transform: scale(0.95); opacity: 0.9; }

.first-btn { background: var(--success); color: #fff; }
.event-btn { background: var(--primary); color: #fff; }
.manual-btn { background: var(--warning); color: #fff; }
.back-btn { background: #444; color: #fff; }

/* ç‹€æ…‹é¡¯ç¤ºå€ */
.confirm { font-size: 36px; color: var(--success); margin-top: 40px; }
.fail { font-size: 36px; color: var(--danger); margin-top: 40px; }
.member-id { font-size: 32px; margin: 20px 0; color: #FFD54F; font-family: monospace; }

/* æƒæå™¨å®¹å™¨ */
#scanner { width: 100%; max-width: 400px; margin: auto; border-radius: 12px; overflow: hidden; }

/* æ‰‹å‹•è¼¸å…¥å®¹å™¨ï¼šä¸¦æ’é¡¯ç¤º */
.manual-input-container {
  display: flex; justify-content: center; gap: 15px; max-width: 420px; margin: 0 auto; }

.input-group { display: flex; flex-direction: column; align-items: flex-start; flex: 1; }
.input-group label { font-size: 14px; color: #888; margin-bottom: 5px; margin-left: 5px; }

/* é‡å°æ‰‹å‹•è¼¸å…¥æ¡†çš„ç‰¹åˆ¥åŠ å¤§ */
#manualPage input {
  width: 100%; height: 90px; font-size: 36px; text-align: center;
  background: #222; border: 2px solid #444; border-radius: 15px;
  padding: 0; }
#manualPage input:focus { border-color: var(--primary); background: #333; }

/* èª¿æ•´éšŠè™Ÿå’ŒéšŠå“¡çš„æ¯”ä¾‹ (6:4) */
.input-group:first-child { flex: 0.6; }
.input-group:last-child { flex: 0.4; }

</style>
</head>

<body>

<header id="header">ğŸ” 2026å¹´é¦™æ¸¯ç¸½ç›£æŒ‘æˆ°ç›¾ç¸½æ±ºè³½ ç°½åˆ°ç³»çµ±</header>

<div id="staffPage" class="page">
  <input id="staffInput" type="text" placeholder="è¼¸å…¥å·¥ä½œäººå“¡åç¨±" 
         style="width:90%; padding:15px; border-radius:8px; font-size:18px;">
  <button class="event-btn" onclick="saveStaff()">é€²å…¥ç³»çµ±</button>
</div>

<div id="eventPage" class="page hidden">
  <button class="first-btn" onclick="selectEvent('æ¸¬è©¦ç”¨')"> æ¸¬è©¦ç”¨</button>
  <button class="event-btn" onclick="selectEvent('ç¹©çµ')">â‘  é …ç›®ä¸€ ç¹©çµ</button>
  <button class="event-btn" onclick="selectEvent('é‡‘æ°éŠæˆ²')">â‘¡ é …ç›®äºŒ é‡‘æ°éŠæˆ²</button>
  <button class="event-btn" onclick="selectEvent('é«”è‚²æŠ€èƒ½')">â‘¢ é …ç›®ä¸‰ é«”è‚²æŠ€èƒ½</button>
  <button class="event-btn" onclick="selectEvent('å°éšŠç«¶æŠ€')">â‘£ é …ç›®å›› å°éšŠç«¶æŠ€</button>
  <button class="event-btn" onclick="selectEvent('åœ˜éšŠæ©Ÿæ™º')">â‘¤ é …ç›®äº” åœ˜éšŠæ©Ÿæ™º</button>
  <button class="event-btn" onclick="selectEvent('ç¥ç§˜é …ç›®')">â‘¥ é …ç›®å…­ ç¥ç§˜é …ç›®</button>
</div>

<div id="scanPage" class="page hidden">
  <div id="scanner"></div>
  <button class="manual-btn" onclick="openManual()">âœï¸ æ‰‹å‹•è¼¸å…¥</button>
  <button class="back-btn" onclick="backToEvent()">â¬… è¿”å›é …ç›®</button>
</div>

<div id="manualPage" class="page hidden">
  <div style="margin-bottom: 20px; color: #FFD54F; font-size: 18px;">è«‹è¼¸å…¥åƒè³½è€…ç·¨è™Ÿ</div>
  
  <div class="manual-input-container">
    <div class="input-group">
      <label>éšŠè™Ÿ (01-26)</label>
      <input id="teamNo" type="number" inputmode="numeric" placeholder="01" min="1" max="26" style="color: #fff;">
    </div>
    
    <div class="input-group">
      <label>éšŠå“¡ (A-I)</label>
      <input id="memberNo" type="text" placeholder="A" maxlength="1" style="text-transform: uppercase; color: #fff;">
    </div>
  </div>

  <button class="event-btn" onclick="submitManual()">ç¢ºèªæäº¤æ•¸æ“š</button>
  <button class="back-btn" onclick="backToScan()">â¬… è¿”å›ç›¸æ©Ÿæƒæ</button>
</div>

<div id="successPage" class="page hidden">
  <div class="confirm">âœ… ç°½åˆ°æˆåŠŸ</div>
  <div id="successMember" class="member-id"></div>
</div>

<div id="failPage" class="page hidden">
  <div class="fail">âŒ ç„¡æ•ˆç·¨è™Ÿ</div>
</div>

<script src="https://unpkg.com/html5-qrcode"></script>

<script>
/**
 * é…ç½®å€ï¼šè«‹å°æ‡‰ä½ çš„ Google è¡¨å–®æ¬„ä½ ID
 * åœ¨è¡¨å–®ã€Œå–å¾—é å…ˆå¡«å¯«çš„é€£çµã€ä¸­å¯ä»¥æ‰¾åˆ°é€™äº› entry.xxxx
 */
const FORM_URL = "https://docs.google.com/forms/d/e/1FAIpQLSfb9TdBGH6aGtpX1chUArd-61hNR2QSOjyZ55_MJkReu4BZCQ/formResponse";
const ENTRIES = {
  member: "entry.440560781",
  event: "entry.722246826",
  staff: "entry.1290533017",
  device: "entry.389796138"
};

// æ­£å‰‡è¡¨é”å¼ï¼šé™åˆ¶éšŠè™Ÿ 01-26ï¼ŒéšŠå“¡ A-I (ä¾‹å¦‚: 05A, 26I)
const MEMBER_REGEX = /^(0[1-9]|1[0-9]|2[0-6])[A-I]$/;

let staff = "", eventName = "";
let html5QrCode = null;
let isProcessing = false; // é˜²æ­¢é‡è¤‡è§¸ç™¼æƒæ
let deviceId = "DEV-" + Math.random().toString(36).substr(2, 4).toUpperCase();

/** é é¢å°èˆªå‡½æ•¸ **/
function show(id) {
  document.querySelectorAll(".page").forEach(p => p.classList.add("hidden"));
  document.getElementById(id).classList.remove("hidden");
}

/** éœ‡å‹•åé¥‹ **/
function vibrate(ms = 100) {
  if (navigator.vibrate) navigator.vibrate(ms);
}

/** å„²å­˜å·¥ä½œäººå“¡ä¸¦é€²å…¥ä¸‹ä¸€é  **/
function saveStaff() {
  staff = document.getElementById("staffInput").value.trim();
  if (!staff) return alert("è«‹è¼¸å…¥å·¥ä½œäººå“¡åç¨±");
  header.innerText = "ğŸ“‹ é¸æ“‡é …ç›®";
  show("eventPage");
}

/** é¸æ“‡æ¯”è³½é …ç›®ä¸¦å•Ÿå‹•ç›¸æ©Ÿ **/
function selectEvent(e) {
  eventName = e;
  header.innerText = "ğŸ“· æƒæ: " + e;
  show("scanPage");
  startScanner();
}

/** åˆå§‹åŒ–ä¸¦å•Ÿå‹• QR æƒæå™¨ **/
async function startScanner() {
  isProcessing = false;
  if (!html5QrCode) {
    html5QrCode = new Html5Qrcode("scanner");
  }
  
  const config = { 
    fps: 10,           // æ¯ç§’æƒææ¬¡æ•¸
    qrbox: 250         // æƒææ¡†å¤§å°
  };
  
  try {
    await html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess);
  } catch (err) {
    console.error("ç›¸æ©Ÿå•Ÿå‹•å¤±æ•—", err);
  }
}

/** åœæ­¢ç›¸æ©Ÿ **/
async function stopScanner() {
  if (html5QrCode && html5QrCode.isScanning) {
    await html5QrCode.stop();
  }
}

/** æƒææˆåŠŸå›èª¿ **/
function onScanSuccess(decodedText) {
  if (isProcessing) return; // é¿å…åœ¨è™•ç†ä¸­é‡è¤‡æƒæ
  isProcessing = true;
  
  const id = decodedText.trim().toUpperCase();
  vibrate(100);

  // é©—è­‰ QR å…§å®¹æ˜¯å¦ç¬¦åˆè¦å‰‡
  if (!MEMBER_REGEX.test(id)) {
    stopScanner();
    show("failPage");
    vibrate(300);
    setTimeout(() => { show("scanPage"); startScanner(); }, 1500);
    return;
  }

  // é©—è­‰é€šéï¼Œæäº¤æ•¸æ“š
  processResult(id);
}

/** è™•ç†æœ€çµ‚çµæœï¼ˆæäº¤èˆ‡é¡¯ç¤ºï¼‰ **/
function processResult(id) {
  stopScanner();
  submitToGoogle(id);
  
  document.getElementById("successMember").innerText = id;
  show("successPage");
  
  // 1.5 ç§’å¾Œè‡ªå‹•è¿”å›æƒæé é¢ï¼Œæº–å‚™ä¸‹ä¸€ä½
  setTimeout(() => {
    show("scanPage");
    startScanner();
  }, 1500);
}

/** ç•°æ­¥æäº¤æ•¸æ“šåˆ° Google Form **/
function submitToGoogle(memberId) {
  // å»ºç«‹å‚™ä»½æ•¸æ“šå­˜æ–¼æ‰‹æ©Ÿï¼Œä»¥é˜²æ–·ç¶²
  const log = { id: memberId, event: eventName, time: new Date().toLocaleTimeString() };
  let history = JSON.parse(localStorage.getItem('logs') || "[]");
  history.push(log);
  localStorage.setItem('logs', JSON.stringify(history));

  // å°è£è¡¨å–®æ•¸æ“š
  const body = new FormData();
  body.append(ENTRIES.member, memberId);
  body.append(ENTRIES.event, eventName);
  body.append(ENTRIES.staff, staff);
  body.append(ENTRIES.device, deviceId);

  // mode: 'no-cors' æ˜¯é—œéµï¼Œå¦å‰‡æœƒå ±è·¨ç¶²åŸŸéŒ¯èª¤
  fetch(FORM_URL, { method: "POST", mode: "no-cors", body: body })
    .catch(() => console.log("æš«æ™‚ç„¡æ³•é€£ç·šè‡³ Googleï¼Œå·²ä¿å­˜æœ¬åœ°å‚™ä»½"));
}

/** æ‰‹å‹•è¼¸å…¥é‚è¼¯ **/
function submitManual() {
  let team = document.getElementById("teamNo").value.padStart(2, "0");
  let mem = document.getElementById("memberNo").value.toUpperCase();
  let id = team + mem;

  if (!MEMBER_REGEX.test(id)) {
    alert("æ ¼å¼ä¸æ­£ç¢º (éšŠè™Ÿ01-26 + A-I)");
    return;
  }

  processResult(id);
  // æ¸…ç©ºè¼¸å…¥æ¬„ä½
  document.getElementById("teamNo").value = "";
  document.getElementById("memberNo").value = "";
}

/** é é¢è·³è½‰è¼”åŠ© **/
function openManual() { stopScanner(); show("manualPage"); header.innerText = "âœï¸ æ‰‹å‹•è¼¸å…¥"; }
function backToScan() { show("scanPage"); startScanner(); header.innerText = "ğŸ“· æƒæ: " + eventName; }
function backToEvent() { stopScanner(); show("eventPage"); header.innerText = "ğŸ“‹ é¸æ“‡é …ç›®"; }

// è‡ªå‹•è·³è½‰ï¼šç•¶éšŠè™Ÿè¼¸å…¥ 2 ä½æ•¸å¾Œï¼Œè‡ªå‹•è·³åˆ°éšŠå“¡ä»£ç¢¼è¼¸å…¥æ¡†
document.getElementById('teamNo').addEventListener('input', function() {
  if (this.value.length >= 2) {
    document.getElementById('memberNo').focus();
  }
});

// å„ªåŒ–ï¼šç•¶é»æ“Šè¼¸å…¥æ¡†æ™‚ï¼Œè‡ªå‹•é¸å–æ–‡å­—ï¼Œæ–¹ä¾¿ä¿®æ”¹
document.querySelectorAll('#manualPage input').forEach(input => {
  input.addEventListener('focus', function() {
    this.select();
  });
});

</script>

</body>
</html>
