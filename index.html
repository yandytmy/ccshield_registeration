<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CC Shield Registeration</title>
<style>
  /* --- åŸºç¤è®Šæ•¸è¨­å®š --- */
  :root { --primary: #1E88E5; --success: #43A047; --bg: #f4f4f4; --dark: #333; }
  
  /* --- ç¶²é æ•´é«”æ¨£å¼ --- */
  body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); margin: 0; }
  header { background: var(--dark); color: white; padding: 15px; text-align: center; font-weight: bold; }
  .container { padding: 15px; max-width: 600px; margin: auto; }
  
  /* --- å¡ç‰‡å…ƒä»¶ --- */
  .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px; }
  
  /* --- è¼¸å…¥æ¡†èˆ‡æ–‡å­—å€åŸŸ --- */
  input, textarea { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box; }
  
  /* --- éšŠå“¡è³‡æ–™åˆ—ä½ˆå±€ --- */
  .member-row { background: #f9f9f9; border: 1px solid #eee; border-radius: 8px; padding: 10px; margin-bottom: 15px; }
  .member-header { display: flex; align-items: center; justify-content: space-between; gap: 10px; margin-bottom: 10px; }
  .member-info-text { font-weight: bold; color: var(--primary); font-size: 16px; flex: 1; }
  
  /* --- éšŠå“¡é ­åƒæ¨£å¼ --- */
  .member-icon { width: 80px; height: 80px; border-radius: 8px; object-fit: cover; border: 2px solid #ddd; background: #eee; }

  /* --- æª¢æŸ¥æ¸…å–®æ–¹æ¡† --- */
  .checklist-box { background: #fffbe6; padding: 10px; border-radius: 8px; border: 1px solid #ffe58f; }
  .check-item { display: flex; align-items: center; padding: 10px 0; border-bottom: 1px solid #eee; cursor: pointer; }
  .check-item:last-child { border-bottom: none; }
  input[type="checkbox"] { width: 22px; height: 22px; margin-right: 12px; }
  
  /* --- æŒ‰éˆ•æ¨£å¼ --- */
  .select-all-btn { background: #eee; border: 1px solid #ccc; padding: 5px 10px; border-radius: 4px; font-size: 13px; margin-bottom: 10px; cursor: pointer; text-align: center; }
  button { width: 100%; padding: 15px; border: none; border-radius: 8px; font-size: 18px; font-weight: bold; margin-top: 10px; cursor: pointer; }
  .btn-primary { background: var(--primary); color: white; }
  .btn-success { background: var(--success); color: white; }
  
  /* --- éš±è—å…ƒä»¶ç”¨çš„é¡åˆ¥ --- */
  .hidden { display: none; }
</style>
</head>
<body>

<header>ğŸ“‹ 2026å¹´é¦™æ¸¯ç¸½ç›£æŒ‘æˆ°ç›¾ç¸½æ±ºè³½ å ±åˆ°ç³»çµ±</header>

<div class="container">
  <div id="step1" class="card">
    <h3>å·¥ä½œäººå“¡ç™»å…¥</h3>
    <input type="text" id="staffName" placeholder="è¼¸å…¥æ‚¨çš„å§“å">
    <button class="btn-primary" onclick="goStep2()">é€²å…¥å ±åˆ°ç¨‹åº</button>
  </div>

  <div id="step2" class="card hidden">
    <h3>è­˜åˆ¥éšŠä¼</h3>
    <input type="number" id="teamNo" placeholder="è«‹è¼¸å…¥éšŠè™Ÿ (01-26)" min="1" max="26">
    <button class="btn-primary" onclick="loadTeamData()">æœå°‹éšŠä¼</button>
    <button style="background:#888; color:white;" onclick="location.reload()">è¿”å›ç™»å…¥</button>
  </div>

  <div id="step3" class="card hidden">
    <h2 id="displayTeamTitle">éšŠä¼ 01 å ±åˆ°æ¸…å–®</h2>
    <div id="memberListContainer"></div> <hr>
    <button class="btn-success" onclick="finalSubmit()">ç¢ºèªä¸¦æäº¤å…¨éšŠè³‡æ–™</button>
  </div>

  <div id="step4" class="card hidden" style="text-align: center;">
    <h2 style="color:var(--success)">âœ… å ±åˆ°å·²æäº¤</h2>
    <p>è©²éšŠè³‡æ–™å·²æˆåŠŸå‚³é€åˆ° Google Sheetã€‚</p>
    <button class="btn-primary" onclick="resetToTeamSelection()">è™•ç†ä¸‹ä¸€éšŠ</button>
  </div>
</div>

<script>
// --- [è¨­å®šå€] API ç¶²å€èˆ‡ Google Form æ¬„ä½ç·¨è™Ÿ ---
const SCRIPT_API_URL = "https://script.google.com/macros/s/AKfycbxMApvuoj4g7zNEdPQOk_-ro6OLOxrvhk_VNyCOMnUr24i9qui7LOSaFSBtfCJevR8o/exec";
const FORM_URL = "https://docs.google.com/forms/d/e/1FAIpQLSeR5ESTo7IWleRlI5KDEBnhI3xJpwR0hTkOWKMKe9tFcM9kSQ/formResponse";

// å°æ‡‰ Google Form çš„ Entry ID
const ENTRIES = {
    staff: "entry.1007120810",
    teamId: "entry.1465479015",
    memId: "entry.1426192719",
    resultA: "entry.1833090949",
    resultB: "entry.1695763412",
    resultC: "entry.1961756043",
    resultD: "entry.466169006",
    resultE: "entry.343479111",
    resultF: "entry.2039460295",
    note: "entry.1273670747"
};

let remoteTeamData = null; // å„²å­˜å¾ Apps Script æŠ“å›ä¾†çš„ JSON ç¸½åå–®
let currentStaff = "";     // å„²å­˜ç›®å‰æ“ä½œçš„å·¥ä½œäººå“¡å§“å

// [åˆå§‹åŒ–] ç¶²é è¼‰å…¥æ™‚è‡ªå‹•åŸ·è¡Œï¼šå¾ Apps Script æŠ“å–æœ€æ–°çš„åå–®
window.onload = function() {
    fetch(SCRIPT_API_URL)
        .then(res => res.json())
        .then(data => {
            remoteTeamData = data;
            console.log("è³‡æ–™åŠ è¼‰å®Œæˆ", data);
        })
        .catch(err => alert("ç„¡æ³•è¼‰å…¥åå–®ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ– API è¨­å®š"));
};

// [åŠŸèƒ½] é€²å…¥ç¬¬äºŒæ­¥ï¼šé©—è­‰å§“åä¸¦åˆ‡æ›ç•«é¢
function goStep2() {
    currentStaff = document.getElementById('staffName').value.trim();
    if (!currentStaff) return alert("è«‹è¼¸å…¥å·¥ä½œäººå“¡åç¨±");
    if (!remoteTeamData) return alert("åå–®ä»åœ¨è®€å–ä¸­ï¼Œè«‹ç¨å€™...");
    document.getElementById('step1').classList.add('hidden');
    document.getElementById('step2').classList.remove('hidden');
}

// [åŠŸèƒ½] è¼‰å…¥éšŠä¼è³‡æ–™ï¼šæ ¹æ“šéšŠè™Ÿç”Ÿæˆ HTML éšŠå“¡æ¸…å–®
function loadTeamData() {
    const rawNo = document.getElementById('teamNo').value;
    const teamKey = rawNo.padStart(2, '0'); // å¼·åˆ¶è½‰ç‚ºå…©ä½æ•¸ï¼Œä¾‹å¦‚ 1 è®Š 01
    const members = remoteTeamData[teamKey];

    if (!members) return alert("æ‰¾ä¸åˆ°è©²éšŠä¼è³‡æ–™");

    document.getElementById('displayTeamTitle').innerText = "éšŠä¼ " + teamKey + " å ±åˆ°æ ¸å°";
    const container = document.getElementById('memberListContainer');
    container.innerHTML = ""; // å…ˆæ¸…ç©ºèˆŠå…§å®¹

    // è¿´åœˆè™•ç†è©²éšŠæ¯ä¸€ä½æˆå“¡
    members.forEach((m) => {
        let iconUrl = m.icon || "";
        // è‡ªå‹•è½‰æ› Google Drive é€£çµï¼Œè®“å®ƒèƒ½ç›´æ¥åœ¨ img æ¨™ç±¤é¡¯ç¤º
        if (iconUrl.includes("drive.google.com")) {
            const fileId = iconUrl.split('/d/')[1]?.split('/')[0];
            iconUrl = `https://lh3.googleusercontent.com/d/${fileId}`;
        }

        // å‹•æ…‹ç”Ÿæˆæ¯å€‹éšŠå“¡çš„ HTML å€å¡Š
        const mDiv = document.createElement('div');
        mDiv.className = "member-row";
        mDiv.innerHTML = `
            <div class="member-header">
                <div class="member-info-text">${m.mem}. ${m.cn} (${m.en})<br>å‡ºç”Ÿæ—¥æœŸ: ${m.dob}</div>
                <img src="${iconUrl}" class="member-icon" onerror="this.src='https://via.placeholder.com/80?text=No+Img'">
            </div>
            <div class="checklist-box">
                <div class="select-all-btn" onclick="selectAll('${m.mem}')">âœ… ä¸€éµå…¨é¸ (A-F)</div>
                <div class="check-item"><input type="checkbox" class="cb_${m.mem}" data-code="A"> A. èº«ä»½è­‰æ˜æ–‡ä»¶</div>
                <div class="check-item"><input type="checkbox" class="cb_${m.mem}" data-code="B"> B. å¹¼ç«¥è»ç´€éŒ„å†Š</div>
                <div class="check-item"><input type="checkbox" class="cb_${m.mem}" data-code="C"> C. æœ‰æ•ˆç´€éŒ„å†Š(å°ç« )</div>
                <div class="check-item"><input type="checkbox" class="cb_${m.mem}" data-code="D"> D. æœ‰æ•ˆæœƒå“¡è³‡æ ¼ï¼ˆå·²çºŒè­‰ï¼‰</div>
                <div class="check-item"><input type="checkbox" class="cb_${m.mem}" data-code="E"> E. ä¸­è‹±æ–‡å§“åã€ç›¸ç‰‡ç›¸ç¬¦</div>
                <div class="check-item"><input type="checkbox" class="cb_${m.mem}" data-code="F"> F. ç©¿ç€æ•´é½Šåˆ¶æœï¼ˆé¡è‰²è† å·¾åœˆã€é»‘è‰²ç¶å¸¶çš®é‹ç­‰ï¼‰</div>
                <textarea id="note_${m.mem}" placeholder="G. é•è¦ç‹€æ³å‚™è¨»(å¦‚ï¼šæˆ´å°ç‹¼é ­ã€ç™½è¥ªã€ä¸æ˜¯ç¶å¸¶é»‘çš®é‹)"></textarea>
            </div>
        `;
        container.appendChild(mDiv);
    });

    document.getElementById('step2').classList.add('hidden');
    document.getElementById('step3').classList.remove('hidden');
}

// [åŠŸèƒ½] ä¸€éµå…¨é¸ï¼šå‹¾é¸è©²è³½å“¡çš„æ‰€æœ‰ A-F æ ¸å–æ¡†
function selectAll(memCode) {
    const checkboxes = document.querySelectorAll(`.cb_${memCode}`);
    checkboxes.forEach(cb => cb.checked = true);
}

// [åŠŸèƒ½] æœ€çµ‚æäº¤ï¼šä¸€æ¬¡å°‡å…¨éšŠéšŠå“¡è³‡æ–™ç™¼é€åˆ° Google Form
async function finalSubmit() {
    const rawNo = document.getElementById('teamNo').value;
    const teamKey = rawNo.padStart(2, '0');
    const members = remoteTeamData[teamKey];
    const submitBtn = document.querySelector('.btn-success');
    
    // é˜²å‘†ç¢ºèª
    if (!confirm("ç¢ºå®šæäº¤å…¨éšŠå…± " + members.length + " ä½éšŠå“¡çš„è³‡æ–™å—ï¼Ÿ")) return;

    // ç¦ç”¨æŒ‰éˆ•é˜²æ­¢é‡è¤‡é»æ“Š
    submitBtn.disabled = true;
    submitBtn.innerText = "æ­£åœ¨æäº¤å…¨éšŠè³‡æ–™...";

    // ä½¿ç”¨ Promise.all åŒæ­¥ç™¼é€å¤šç­†è³‡æ–™
    const promises = members.map(m => {
        const formData = new FormData();
        formData.append(ENTRIES.staff, currentStaff);
        formData.append(ENTRIES.teamId, teamKey);
        formData.append(ENTRIES.memId, m.mem); 
        
        // æŠ“å–æ¯ä¸€é … A-F çš„ç‹€æ…‹ä¸¦è½‰æ›ç‚ºæ–‡å­—
        ['A', 'B', 'C', 'D', 'E', 'F'].forEach(code => {
            const isChecked = document.querySelector(`.cb_${m.mem}[data-code="${code}"]`).checked;
            formData.append(ENTRIES['result' + code], isChecked ? "OK" : "FAILED");
        });

        // æŠ“å–å€‹äººå‚™è¨»æ–‡å­—
        const individualNote = document.getElementById(`note_${m.mem}`).value;
        formData.append(ENTRIES.note, individualNote);

        // ç™¼é€ POST è«‹æ±‚åˆ° Google Form
        return fetch(FORM_URL, { method: "POST", mode: "no-cors", body: formData });
    });

    try {
        await Promise.all(promises); // ç­‰å¾…æ‰€æœ‰éšŠå“¡è³‡æ–™ç™¼é€å®Œç•¢
        document.getElementById('step3').classList.add('hidden');
        document.getElementById('step4').classList.remove('hidden');
        window.scrollTo(0, 0);
    } catch (err) {
        alert("ç¶²è·¯éŒ¯èª¤ï¼Œè«‹é‡è©¦");
        submitBtn.disabled = false;
        submitBtn.innerText = "ç¢ºèªä¸¦æäº¤å…¨éšŠè³‡æ–™";
    }
}

// [åŠŸèƒ½] é‡ç½®ï¼šå›åˆ°éšŠä¼é¸æ“‡ç•«é¢ï¼Œä¸¦æ¸…ç©ºæš«å­˜è³‡æ–™
function resetToTeamSelection() {
    document.getElementById('teamNo').value = "";
    const container = document.getElementById('memberListContainer');
    if (container) container.innerHTML = ""; // å¾¹åº•ç§»é™¤ä¸Šå€‹éšŠä¼çš„ HTML
    
    document.getElementById('step4').classList.add('hidden');
    document.getElementById('step2').classList.remove('hidden');
    
    // æ¢å¾©æäº¤æŒ‰éˆ•å¯ç”¨
    const submitBtn = document.querySelector('.btn-success');
    if (submitBtn) {
        submitBtn.disabled = false;
        submitBtn.innerText = "ç¢ºèªä¸¦æäº¤å…¨éšŠè³‡æ–™";
    }
    window.scrollTo(0, 0);
}
</script>
</body>
</html>
