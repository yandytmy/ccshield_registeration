<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CC Shield Registeration</title>
<style>
  :root { --primary: #1E88E5; --success: #43A047; --bg: #f4f4f4; --dark: #333; }
  body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); margin: 0; }
  header { background: var(--dark); color: white; padding: 15px; text-align: center; font-weight: bold; }
  .container { padding: 15px; max-width: 600px; margin: auto; }
  .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px; }
  
  /* Input & Select */
  input, textarea { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box; }
  
  /* Member Info Table */
  .member-row { background: #f9f9f9; border: 1px solid #eee; border-radius: 8px; padding: 10px; margin-bottom: 15px; }
  .member-name { font-weight: bold; color: var(--primary); font-size: 18px; }
  .member-icon { width: 80px; height: 80px; border-radius: 8px; object-fit: cover; border: 2px solid #ddd; background: #eee; /* åœ–ç‰‡è¼‰å…¥å‰çš„åº•è‰² */ }

  /* Checklist Style */
  .checklist-box { background: #fffbe6; padding: 10px; border-radius: 8px; border: 1px solid #ffe58f; }
  .check-item { display: flex; align-items: center; padding: 10px 0; border-bottom: 1px solid #eee; cursor: pointer; }
  .check-item:last-child { border-bottom: none; }
  input[type="checkbox"] { width: 22px; height: 22px; margin-right: 12px; }
  
  .select-all-btn { background: #eee; border: 1px solid #ccc; padding: 5px 10px; border-radius: 4px; font-size: 13px; margin-bottom: 10px; cursor: pointer; }
  
  button { width: 100%; padding: 15px; border: none; border-radius: 8px; font-size: 18px; font-weight: bold; margin-top: 10px; cursor: pointer; }
  .btn-primary { background: var(--primary); color: white; }
  .btn-success { background: var(--success); color: white; }
  .hidden { display: none; }
</style>
</head>
<body>

<header>ğŸ“‹ 2026ï¦é¦™æ¸¯ç¸½ç›£æŒ‘æˆ°ç›¾ç¸½æ±ºè³½ å ±åˆ°ç³»çµ±</header>

<div class="container">
  <div id="step1" class="card">
    <h3>å·¥ä½œäººå“¡ç™»å…¥</h3>
    <input type="text" id="staffName" placeholder="è¼¸å…¥æ‚¨çš„å§“å">
    <button class="btn-primary" onclick="goStep2()">é€²å…¥å ±åˆ°ç¨‹åº</button>
  </div>

  <div id="step2" class="card hidden">
    <h3>è­˜åˆ¥éšŠä¼</h3>
    <input type="number" id="teamNo" placeholder="è«‹è¼¸å…¥éšŠè™Ÿ (01-26)" min="1" max="26">
    <button class="btn-primary" onclick="loadTeamData()">æœå°‹éšŠä¼</button>
    <button style="background:#888; color:white;" onclick="location.reload()">è¿”å›ç™»å…¥</button>
  </div>

  <div id="step3" class="card hidden">
    <h2 id="displayTeamTitle">éšŠä¼ 01 å ±åˆ°æ¸…å–®</h2>
    <div id="memberListContainer">
        </div>
    
    <hr>
    <button class="btn-success" onclick="finalSubmit()">ç¢ºèªä¸¦æäº¤å…¨éšŠè³‡æ–™</button>
  </div>

  <div id="step4" class="card hidden" style="text-align: center;">
    <h2 style="color:var(--success)">âœ… å ±åˆ°å·²æäº¤</h2>
    <p>è©²éšŠè³‡æ–™å·²æˆåŠŸå‚³é€åˆ° Google Sheetã€‚</p>
    <button class="btn-primary" onclick="resetToTeamSelection()">è™•ç†ä¸‹ä¸€éšŠ</button>
  </div>
</div>

<script>
// ========== 1. è³‡æ–™åº« (é€™éƒ¨åˆ†å»ºè­°å¾ Google Sheet è½‰ç‚º JSON è²¼ä¸Š) ==========
// ç¾æ™‚ä½¿ç”¨Apps Script
const SCRIPT_API_URL = "https://script.google.com/macros/s/AKfycbxMApvuoj4g7zNEdPQOk_-ro6OLOxrvhk_VNyCOMnUr24i9qui7LOSaFSBtfCJevR8o/exec";

// ========== 2. Google Form è¨­å®š ==========
const FORM_URL = "https://docs.google.com/forms/d/e/1FAIpQLSeR5ESTo7IWleRlI5KDEBnhI3xJpwR0hTkOWKMKe9tFcM9kSQ/formResponse";
const ENTRIES = {
    staff: "entry.1007120810",
    teamId: "entry.1465479015",
    memId: "entry.1426192719",
    resultA: "entry.1833090949", // å„²å­˜æ‰€æœ‰éšŠå“¡çš„æª¢æŸ¥çµæœ
    resultB: "entry.1695763412", // å„²å­˜æ‰€æœ‰éšŠå“¡çš„æª¢æŸ¥çµæœ
    resultC: "entry.1961756043", // å„²å­˜æ‰€æœ‰éšŠå“¡çš„æª¢æŸ¥çµæœ
    resultD: "entry.466169006", // å„²å­˜æ‰€æœ‰éšŠå“¡çš„æª¢æŸ¥çµæœ
    resultE: "entry.343479111", // å„²å­˜æ‰€æœ‰éšŠå“¡çš„æª¢æŸ¥çµæœ
    resultF: "entry.2039460295", // å„²å­˜æ‰€æœ‰éšŠå“¡çš„æª¢æŸ¥çµæœ
    note: "entry.1273670747"
};

let remoteTeamData = null; // ç”¨ä¾†å„²å­˜å¾ç¶²è·¯ä¸ŠæŠ“åˆ°çš„è³‡æ–™
let currentStaff = "";

// ç¶²é é–‹å•Ÿæ™‚ï¼Œè‡ªå‹•å»æŠ“åå–®
window.onload = function() {
    fetch(SCRIPT_API_URL)
        .then(res => res.json())
        .then(data => {
            remoteTeamData = data;
            console.log("è³‡æ–™åŠ è¼‰å®Œæˆ", data);
        })
        .catch(err => alert("ç„¡æ³•è¼‰å…¥åå–®ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ– API è¨­å®š"));
};

function goStep2() {
    currentStaff = document.getElementById('staffName').value.trim();
    if (!currentStaff) return alert("è«‹è¼¸å…¥å·¥ä½œäººå“¡åç¨±");
    if (!remoteTeamData) return alert("åå–®ä»åœ¨è®€å–ä¸­ï¼Œè«‹ç¨å€™...");
    
    document.getElementById('step1').classList.add('hidden');
    document.getElementById('step2').classList.remove('hidden');
}

function loadTeamData() {
    const rawNo = document.getElementById('teamNo').value;
    const teamKey = rawNo.padStart(2, '0');
    const members = remoteTeamData[teamKey];

    if (!members) return alert("æ‰¾ä¸åˆ°è©²éšŠä¼è³‡æ–™");

    document.getElementById('displayTeamTitle').innerText = "éšŠä¼ " + teamKey + " å ±åˆ°æ ¸å°";
    const container = document.getElementById('memberListContainer');
    container.innerHTML = ""; 

    members.forEach((m) => {
        // å¦‚æœä½ çš„åœ–ç‰‡åœ¨ Google Driveï¼Œé€™è£¡å¯ä»¥åšä¸€å€‹ç°¡å–®çš„è‡ªå‹•è½‰æ› (é¸æ“‡æ€§)
        let iconUrl = m.icon || "";
        if (iconUrl.includes("drive.google.com")) {
            const fileId = iconUrl.split('/d/')[1]?.split('/')[0];
            iconUrl = `https://lh3.googleusercontent.com/u/0/d/${fileId}`;
        }

        const mDiv = document.createElement('div');
        mDiv.className = "member-row";
        mDiv.innerHTML = `
            <div class="member-header">
                <div class="member-info-text">${m.mem}. ${m.cn} (${m.en}) å‡ºç”Ÿæ—¥æœŸ: ${m.dob}</div>
                <img src="${iconUrl}" class="member-icon" onerror="this.src='https://via.placeholder.com/80?text=No+Img'">
            </div>
            <div class="checklist-box">
                <div class="select-all-btn" onclick="selectAll('${m.mem}')">âœ… ä¸€éµå…¨é¸ (A-F)</div>
                <div class="check-item"><input type="checkbox" class="cb_${m.mem}" data-code="A"> A. èº«ä»½è­‰æ˜æ–‡ä»¶</div>
                <div class="check-item"><input type="checkbox" class="cb_${m.mem}" data-code="B"> B. å¹¼ç«¥è»ç´€éŒ„å†Š</div>
                <div class="check-item"><input type="checkbox" class="cb_${m.mem}" data-code="C"> C. æœ‰æ•ˆç´€éŒ„å†Š(å°ç« )</div>
                <div class="check-item"><input type="checkbox" class="cb_${m.mem}" data-code="D"> D. æœ‰æ•ˆæœƒå“¡è³‡æ ¼ï¼ˆå·²çºŒè­‰ï¼‰</div>
                <div class="check-item"><input type="checkbox" class="cb_${m.mem}" data-code="E"> E. ä¸­è‹±æ–‡å§“åã€ç›¸ç‰‡ç›¸ç¬¦</div>
                <div class="check-item"><input type="checkbox" class="cb_${m.mem}" data-code="F"> F. ç©¿ç€æ•´é½Šåˆ¶æœï¼ˆé¡è‰²è† å·¾åœˆã€é»‘è‰²ç¶å¸¶çš®é‹ç­‰ï¼‰</div>
                <textarea id="note_${m.mem}" placeholder="G. é•è¦ç‹€æ³å‚™è¨»(å¦‚ï¼šæˆ´å°ç‹¼é ­ã€ç™½è¥ªã€ä¸æ˜¯ç¶å¸¶é»‘çš®é‹)"></textarea>
            </div>
        `;
        container.appendChild(mDiv);
    });

    document.getElementById('step2').classList.add('hidden');
    document.getElementById('step3').classList.remove('hidden');
}

function selectAll(memCode) {
    const checkboxes = document.querySelectorAll(`.cb_${memCode}`);
    checkboxes.forEach(cb => cb.checked = true);
}

async function finalSubmit() {
    const rawNo = document.getElementById('teamNo').value;
    const teamKey = rawNo.padStart(2, '0');
    const members = remoteTeamData[teamKey];

    const submitBtn = document.querySelector('.btn-success');
    submitBtn.disabled = true;
    submitBtn.innerText = "æ­£åœ¨æäº¤å…¨éšŠè³‡æ–™...";

    const promises = members.map(m => {
        const formData = new FormData();
        formData.append(ENTRIES.staff, currentStaff);
        formData.append(ENTRIES.teamId, teamKey);
        formData.append(ENTRIES.memId, m.mem); 
        
        // æŠ“å– A-F å‹¾é¸ç‹€æ…‹
        ['A', 'B', 'C', 'D', 'E', 'F'].forEach(code => {
            const isChecked = document.querySelector(`.cb_${m.mem}[data-code="${code}"]`).checked;
            formData.append(ENTRIES['result' + code], isChecked ? "OK" : "FAILED");
        });

        // é‡è¦ä¿®æ­£ï¼šæ ¹æ“š ID æŠ“å–è©²ä½è³½å“¡çš„å°ˆå±¬å‚™è¨»
        const individualNote = document.getElementById(`note_${m.mem}`).value;
        formData.append(ENTRIES.note, individualNote);

        return fetch(FORM_URL, { method: "POST", mode: "no-cors", body: formData });
    });

    try {
        await Promise.all(promises);
        document.getElementById('step3').classList.add('hidden');
        document.getElementById('step4').classList.remove('hidden');
        window.scrollTo(0, 0);
    } catch (err) {
        alert("ç¶²è·¯éŒ¯èª¤ï¼Œè«‹é‡è©¦");
        submitBtn.disabled = false;
        submitBtn.innerText = "ç¢ºèªä¸¦æäº¤å…¨éšŠè³‡æ–™";
    }
}

function resetToTeamSelection() {
    // 1. æ¸…ç©ºæ‰€æœ‰è¼¸å…¥æ¬„ä½
    document.getElementById('teamNo').value = "";
    
    // 2. å¾¹åº•æ¸…ç©ºéšŠå“¡æ¸…å–®å®¹å™¨ï¼Œé˜²æ­¢æ®˜ç•™
    const container = document.getElementById('memberListContainer');
    if (container) container.innerHTML = ""; 

    // 3. éš±è—ã€ŒæˆåŠŸç•«é¢ã€(Step 4)ï¼Œé¡¯ç¤ºã€ŒéšŠä¼è¼¸å…¥ã€(Step 2)
    document.getElementById('step4').classList.add('hidden');
    document.getElementById('step2').classList.remove('hidden');

    // 4. é‡ç½®æäº¤æŒ‰éˆ•ç‹€æ…‹ï¼ˆæ¢å¾©ç‚ºå¯é»æ“Šï¼‰
    const submitBtn = document.querySelector('.btn-success');
    if (submitBtn) {
        submitBtn.disabled = false;
        submitBtn.innerText = "ç¢ºèªä¸¦æäº¤å…¨éšŠè³‡æ–™";
    }

    // 5. ç•«é¢æ²å‹•å›é ‚éƒ¨
    window.scrollTo(0, 0);
}

</script>
</body>
</html>